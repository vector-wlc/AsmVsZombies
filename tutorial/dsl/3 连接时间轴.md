# 3 连接时间轴

前面曾强调过，**定义时间轴并不意味着执行操作**（如果你忘了，编译器也会用报错告诉你）。想要执行操作，需要把时间轴绑定到绝对时间。绑定的过程和构建时间轴使用同一套语法：把绝对时间填入 `At` 的小括号里，后面跟着要绑定的操作即可。

```cpp
// 1_wave 就是一个绝对时间，相当于 ATime(1, 0)
At(1_wave) {
    At(401_cs) PP(),
};
// 相当于
AConnect(ATime(1, 401), PP());

// 绝对时间只能有一个，而且必须在最外层
// At(401_cs) At(1_wave) PP(); 是不行的

At(ATime(2, 1 - 100)) Do {
    // Do 里面是一个程序块，块里的内容会在 ATime(2, 1 - 100) 这个时间点运行
    // 和在 AScript() 里一样，想使用时间轴操作仍然需要指定一个绝对时间。At(now) 就是现在执行的意思
    At(now) Card(AICE_SHROOM, 1, 1);
    At(now + 100_cs) Do { logger.Info("冰生效"); };
}; // 注意结尾分号
// 相当于
AConnect(ATime(2, 1 - 100), []{
    AConnect(ANowTime(), Card(AICE_SHROOM, 1, 1));
    AConnect(ANowDelayTime(100), []{ logger.Info("冰生效"); });
});

At(ATime(2, 1)) Do {
    At(now) I(1, 1); // 这样写是错的！
                     // I(1, 1) 以生效时间为基准，需要提前 100cs 放冰，但它被连接到了 now，now - 100_cs 已经过去了
                     // 这就相当于你在看到第二波僵尸出来之后才想起“这波应该预判冰”，肯定是不行的
    logger.Info("冰生效");
};
// 应该
At(ATime(2, 1)) {
    I(1, 1), // 这种写法中操作会在执行脚本时（如果你没有阻塞脚本的话，就是战斗开始的瞬间）被绑定，这时 ATime(2, 1) - 100_cs 还尚未到达
    Do { logger.Info("冰生效"); },
};
```

DSL 还支持把同样的操作连接到多波。

```cpp
// 把操作在第 1-3 波每波各执行一次
At(1_3_wave) {
    ...
};
At(10_19_step3_wave) // 第 10、13、16、19 波
At(1_8_wave, 10_18_wave, 20_wave) // 第 1-8、10-18、20 波
At(AWave(1_8, 10_18, 20)) // 同上
OnWave(1_8, 10_18, 20) // OnWave(...) 是 At(AWave(...)) 的简写
```

此外，还有一种特殊的连接语法：假设 `a`、`b`、`c` 是三个时间轴，则可以通过 `a | b | c` 创建一个**轨道**（类型名为 `ASequence`）。轨道是无限循环往复的一列时间轴，当轨道被连接到多个波次时，各个波次会**按顺序逐个连接轨道中的时间轴**。举个例子：

```cpp
OnWave(1_3, 5_9) a | b | c;
/*
波次  1   2   3   5   6   7   8   9
操作  a   b   c   a   b   c   a   b
注意：第 5 波的操作仍然是第 3 波的后继，中间跳过的波次不会影响轨道的循环
*/

// 相当于
OnWave(1, 5, 8) a;
OnWave(2, 6, 9) b;
OnWave(3, 7) c;
```

但是，上面的例子还有一个不足：如果第一波想从 `b` 开始怎么办呢？如果想空出第 4 波，让第 5 波的相位和第 2 波一样呢？这时我们需要 **人工指定相位**。

```cpp
// % 后的数字指定了起始相位（从 1 开始计数）
OnWave(1_3 % 2, 5_9 % 3) a | b | c;
/*
相位是一个递增的计数器，% 运算符会重置其值（比如 5_9_wave % 3 就会把第 5 波的相位赋值为 3，后面在此基础上继续递增）
波次  1   2   3   5   6   7   8   9
相位  2   3   4   3   4   5   6   7
操作  b   c   a   c   a   b   c   a
*/
```

[目录](../00_catalogue.md)

